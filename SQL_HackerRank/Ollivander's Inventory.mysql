SELECT D.ID, D.AGE, D.COINS_NEEDED,D.POWER
FROM(
SELECT A.ID, B.AGE
     , A.COINS_NEEDED
     , A.POWER
    , B.IS_EVIL
     , ROW_NUMBER() OVER(PARTITION BY B.AGE,A.POWER ORDER BY A.COINS_NEEDED) C
FROM WANDS A INNER JOIN WANDS_PROPERTY B ON A.CODE = B.CODE
    ) D
WHERE D.IS_EVIL = 0 AND D.C=1
ORDER BY D.POWER DESC,D.AGE DESC
